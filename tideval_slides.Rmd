---
title: "Tidyeval Tutorial"
author: "Michael Battaglia"
date: "6/30/2017"
output: 
  ioslides_presentation:
    widescreen: true
    smaller: true
    logo: methods_logo.png
    css: purrr_tutorial.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, error = TRUE)

library(tidyverse)
library(rlang)
library(knitr)

```

## Data

```{r}
data(mtcars)
head(mtcars)
```


## Basic intro to !! quo and sym

```{r}
mtcars %>%
  filter(gear == 4) %>%
  head(n=3) %>%
  kable()
```

## Basic intro to !! quo and sym

```{r}
x <- "gear"

mtcars %>%
  filter(x == 4) %>%
  head(n=3) %>%
  kable()

expr(
  mtcars %>%
    filter(x == 4) %>%
    head(n=3) %>%
    kable()
)
```

Filter ignores that x has an assigned value, "gear". We would like x to be evaluated (replaced with "gear") prior to being used by filter.

## Basic intro to !! quo and sym

```{r}
mtcars %>%
  filter((!!x) == 4) %>%
  head(n=3) %>%
  kable()

expr(
  mtcars %>%
    filter((!!x) == 4) %>%
    head(n=3) %>%
    kable()
)
```

!! makes R evaluate x a step before evaluating the whole expression

However we don't want a string there, we want the object name to be a symbol. 

## Basic intro to !! quo and sym

```{r}
x <- sym("gear")

mtcars %>%
  filter((!!x) == 4) %>%
  head(n=3) %>%
  kable()
```

## Basic intro to !! quo and sym

```{r}
expr(
  mtcars %>%
    filter((!!x) == 4) %>%
    head(n=3) %>%
    kable()
)
```

## Basic intro to !! quo and sym

If we want our input to be plain text, not a string, use quo

```{r}
x <- quo(gear)

mtcars %>%
  filter((!!x) == 4) %>%
  head(n=3) %>%
  kable()
```


## Definitions

`!!`: The `!!` operator, or bangbang, tells R to evaluate the object prior to using it. 

`sym()`: takes string input and converts to symbol

`quo()`: takes unquoted R code and returns expression ready to be evaluated

`enquo()`: takes symbol referring to function argument, works similarly to `quo()`

## tl;dr

Outside function: sym and quo

Inside function: sym and enquo

## Enquo and sym example

```{r}
mtcars %>% 
  count(cyl) %>% 
  mutate(prop = n / sum(n)) %>%
  kable()
```

## Enquo and sym example

```{r}
categorical_summary <- function(df, count_var) {

  count_var <- enquo(count_var)
  
  df %>% 
    count(!!count_var) %>%
    mutate(prop = n / sum(n)) %>%
    kable()
  
}
```

## Enquo and sym example

```{r}
mtcars %>% 
  categorical_summary(cyl)

mtcars %>% 
  categorical_summary("cyl")
```

## Enquo and sym example

```{r}
categorical_summary_string <- function(df, count_var) {
  
  count_var <- sym(count_var)
  
  df %>% 
    count(!!count_var) %>%
    mutate(prop = n / sum(n)) %>%
    kable()
  
}

mtcars %>% 
  categorical_summary_string("cyl")
```

## Bigger Example

```{r}
mtcars %>%
  filter(vs == 0) %>%
  group_by(cyl) %>%
  summarise(hp = mean(hp)) %>%
  kable()
```

Goal is to functionize replacing everything with arguments

We'll start trying to replace cyl with group_var

## Bigger Example

```{r}
summariser <- function(df, group_var) {
  
  df %>%
    filter(vs == 0) %>%
    group_by(group_var) %>%
    summarise(hp = mean(hp)) %>%
    kable()
  
}

summariser(mtcars, cyl)
```

## Bigger Example

```{r}
summariser <- function(df, group_var) {
  expr(
    df %>%
      filter(vs == 0) %>%
      group_by(group_var) %>%
      summarise(hp = mean(hp)) %>%
      kable()
  )
}

summariser(mtcars, cyl)
```

It tries to group by "group_var", where we want it to group by the user specified "cyl". 

group_by (and other dplyr verbs) does not evaluate the input, it quotes it and then uses the quoted object.

## Bigger Example

We need to quote the input ourselves and then tell group_by to evaluate it prior to using it

enquo takes a symbol refering to a fuction argument, and returns a quosure with the R code that was supplied by the user to this argument. 

!! tells group_by to evaluate (unquote) group_var before using it 

## Bigger Example

```{r}
summariser <- function(df, group_var) {
  
  group_var <- enquo(group_var)
  
  df %>%
    filter(vs == 0) %>%
    group_by(!!group_var) %>%
    summarise(hp = mean(hp))  %>%
    kable()
  
}

summariser(mtcars, cyl)
```


## Bigger Example

```{r}
summariser <- function(df, group_var) {
  
  group_var <- enquo(group_var)
  
  expr(  
    df %>%
      filter(vs == 0) %>%
      group_by(!!group_var) %>%
      summarise(hp = mean(hp))  %>%
      kable()
  )
  
}

summariser(mtcars, cyl)
```

## Bigger Example

We can also use quosures to assign an expression directly to an argument

```{r}
summariser <- function(df, expression, group_var) {
  group_var <- enquo(group_var)
  expression <- enquo(expression)

  df %>%
    filter(!!expression) %>%
    group_by(!!group_var) %>%
    summarise(hp = mean(hp)) %>%
    kable() 
  
}

summariser(mtcars, vs == 0, cyl)
```

## Bigger Example

```{r}
summariser <- function(df, expression, group_var, summary_var) {
  
  group_var <- enquo(group_var)
  summary_var <- enquo(summary_var)
  expression <- enquo(expression)
  
  df %>%
    filter(!!expression) %>%
    group_by(!!group_var) %>%
    summarise(x = mean(!!summary_var)) %>%
    kable() 
  
}

summariser(mtcars, vs == 0, cyl, hp)
```

## Bigger Example

```{r}
summariser <- function(df, expression, group_var, summary_var) {
  
  group_var <- enquo(group_var)
  summary_var <- enquo(summary_var)
  expression <- enquo(expression)
  
  df %>%
    filter(!!expression) %>%
    group_by(!!group_var) %>%
    summarise(!!summary_var = mean(!!summary_var)) %>%
    kable() 
  
}
```

`!!summary_var = mean(!!summary_var)` is not valid R code, need to use `:=` operator to unquote on both RHS and LHS

## Bigger Example

```{r}
summariser <- function(df, expression, group_var, summary_var) {
  
  group_var <- enquo(group_var)
  summary_var <- enquo(summary_var)
  expression <- enquo(expression)
  
    df %>%
      filter(!!expression) %>%
      group_by(!!group_var) %>%
      summarise(!!summary_var := mean(!!summary_var)) %>%
      kable()
  
}

summariser(mtcars, vs == 0, cyl, hp)
```

## Bigger Example

```{r}
summariser <- function(df, expression, group_var, summary_var) {
  
  group_var <- enquo(group_var)
  summary_var <- enquo(summary_var)
  expression <- enquo(expression)
  
  expr(
    df %>%
      filter(!!expression) %>%
      group_by(!!group_var) %>%
      summarise(!!summary_var := mean(!!summary_var) %>%
      kable())
  )
  
}

summariser(mtcars, vs == 0, cyl, hp)
```

## Bigger Example

```{r}
summariser <- function(df, expression, group_var, summary_var) {
  
  group_var <- enquo(group_var)
  summary_var <- enquo(summary_var)
  expression <- enquo(expression)
  
  df %>%
    filter(!!expression) %>%
    group_by(!!group_var) %>%
    summarise(!!quo_name(summary_var) := mean(!!summary_var)) %>%
    kable()
  
}

summariser(mtcars, vs == 0, cyl, hp)
```

## Bigger Example

```{r}
summariser <- function(df, expression, group_var, summary_var) {
  
  group_var <- enquo(group_var)
  summary_var <- enquo(summary_var)
  expression <- enquo(expression)
  
  expr(  
    df %>%
      filter(!!expression) %>%
      group_by(!!group_var) %>%
      summarise(!!quo_name(summary_var) := mean(!!summary_var)) %>%
      kable()
  )
  
}

summariser(mtcars, vs == 0, cyl, hp)
```

The quo_name function replaces the quosure ~hp with "hp"

## Quos example

```{r}

g <- c("gear", "cyl")

multiple_group <- function(df, val_var, ...) {
  
  val_var <- enquo(val_var)
  groupings <- syms(groupings)
  
  df %>%
    group_by(!!!groupings) %>%
    summarise(mean(!!val_var))
  
}

multiple_group(mtcars, g, hp)

```

## Quos example

```{r}

g1 <- c("gear", "cyl")
g2 <- c("gear")

multiple_group <- function(df, val_var, groupings) {
  
  val_var <- enquo(val_var)
  groupings <- syms(groupings)
  
  df %>%
    group_by(!!!groupings) %>%
    summarise(mean(!!val_var))
  
}

multiple_group(mtcars, hp, g1)
multiple_group(mtcars, hp, g2)

```


```{r}
multiple_group <- function(df, val_var, ...) {
  
  val_var <- enquo(val_var)
  groupings <- quos(...)
  
  df %>%
    group_by(!!!groupings) %>%
    summarise(mean(!!val_var))
  
}

multiple_group(mtcars, hp, gear)
multiple_group(mtcars, hp, gear, cyl)

```


## Quos example 2

```{r}
(example <- tibble(group=c(rep("A",6), rep("B",6)), val = c(1:5, NA, 7:11, 1000)))
```

## Quos example 2

```{r}
grouped_mean <- function(df, grouping_var, val_var, ...) {
  
  args <- quos(...)
  grouping_var <- enquo(grouping_var)
  val_var <- enquo(val_var)
  
  df %>%
    group_by(!!grouping_var) %>%
    summarise(value = mean(!!val_var, !!!args)) %>%
    kable()
  
}
```

## Quos example 2

```{r}
grouped_mean(example, group, val)
grouped_mean(example, group, val, na.rm = TRUE)
```

## Quos example 2

```{r}
grouped_mean(example, group, val, trim = .2)
grouped_mean(example, group, val, na.rm = TRUE, trim = .2)
```

