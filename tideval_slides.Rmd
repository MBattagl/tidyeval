---
title: "Tidyeval Tutorial"
author: "Michael Battaglia"
date: "6/30/2017"
output: 
  ioslides_presentation:
    widescreen: true
    smaller: true
    logo: methods_logo.png
    css: purrr_tutorial.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, error = TRUE)

library(tidyverse)
library(rlang)
library(knitr)

```

## Data

```{r}
data(mtcars)
head(mtcars)
```

## Important Concepts

- Standard vs Non-Standard Evalulation

- Quosures

## Standard vs Non-Standard Evalulation

Standard evaluation: R passes arguments by value. 

Non-standard evaluation (NSE): Catch-all term that means anything other than standard evaluation.

Dplyr NSE: Allows objects that do not exist in global environment as inputs. 

```{r}
mtcars %>%
  select(cyl) %>%
  head(n=3)
```

With standard evaluation, this would fail as cyl doesn't exist.

## Non-Standard Evalulation Issues

While NSE can be extremely convienient, it causes problems when using non-interactively. 

```{r}
oops <- function(var) {
  mtcars %>%
    select(var)
}

oops(cyl)
```

This is where tidyeval comes in.

## Tidyeval

- Tidyeval is a toolkit for the tidyverse

- It was created to help get around the issues that NSE can cause 

- Elegantly functionize dplyr code (other tidyverse packages will have support soon)


## Intro to BangBang

```{r}
mtcars %>%
  select(2) %>%
  head(n=3)
```

```{r}
hp <- 2

mtcars %>%
  select(hp) %>%
  head(n=3)
```

## Intro to BangBang

The `!!` operator, pronounced BangBang, tells R to evaluate the object prior to using it. 

```{r}
mtcars %>%
  select(!!hp) %>%
  head(n=3)
```

## Intro to BangBang

`expr()` allows us to debug our tidyeval code, lets us see what R is trying to evaluate

```{r}
expr(
  mtcars %>%
    select(hp) %>%
    head(n=3)
)
```

```{r}
expr(
  mtcars %>%
    select(!!hp) %>%
    head(n=3)
)
```

## Intro to quo and sym

```{r}
mtcars %>%
  filter(gear == 4) %>%
  head(n=3) %>%
  kable()
```

## Intro to quo and sym

```{r}
x <- "gear"

mtcars %>%
  filter(x == 4) %>%
  head(n=3) %>%
  kable()

expr(
  mtcars %>%
    filter(x == 4) %>%
    head(n=3) %>%
    kable()
)
```

Filter ignores that x has an assigned value, "gear". We would like x to be evaluated (replaced with "gear") prior to being used by filter.

## Intro to quo and sym

```{r}
mtcars %>%
  filter((!!x) == 4) %>%
  head(n=3) %>%
  kable()

expr(
  mtcars %>%
    filter((!!x) == 4) %>%
    head(n=3) %>%
    kable()
)
```

`!!` tells R to evaluate `x` a step before evaluating the whole expression

However we don't want a string there, we want the object name to be a symbol. 

## Intro to quo and sym

```{r}
x <- sym("gear")

mtcars %>%
  filter((!!x) == 4) %>%
  head(n=3) %>%
  kable()
```

## Intro to quo and sym

```{r}
expr(
  mtcars %>%
    filter((!!x) == 4) %>%
    head(n=3) %>%
    kable()
)
```

## Intro to quo and sym

If we want our input to be plain text, not a string, use quo

```{r}
x <- quo(gear)

mtcars %>%
  filter((!!x) == 4) %>%
  head(n=3) %>%
  kable()
```


## Definitions

`!!`: tells R to evaluate the object prior to using it.

`sym()`: takes string input and converts to symbol

`quo()`: takes unquoted R code and returns a quosure ready to be evaluated

quosure: a quosure is a quoted object that keeps track of an environment

`enquo()`: takes symbol referring to function argument, works similarly to `quo()`

## tl;dr

***Coding interactively*** (useful while building function): use `sym()` or `quo()`

***Inside function***: use `sym()` or `enquo()`

## Enquo and sym example

```{r}
mtcars %>% 
  select(cyl) %>% 
  head(n=3) %>%
  kable()
```

## Enquo and sym example

```{r}
categorical_summary <- function(df, select_var) {

  select_var <- enquo(select_var)
  
  df %>% 
    select(!!select_var) %>% 
    head(n=3) %>%
    kable()
  
}

mtcars %>% 
  categorical_summary(cyl)
```

## Enquo and sym example

```{r}
categorical_summary_string <- function(df, select_var) {
  
  select_var <- sym(select_var)
  
  df %>% 
    select(!!select_var) %>% 
    head(n=3) %>%
    kable()

}

mtcars %>% 
  categorical_summary_string("cyl")
```

## Bigger Example

```{r}
mtcars %>%
  filter(vs == 0) %>%
  group_by(cyl) %>%
  summarise(hp = mean(hp)) %>%
  kable()
```

Goal is to functionize replacing everything with arguments.

We'll start by trying to replace cyl.

## Bigger Example

```{r}
summariser <- function(df, group_var) {
  
  group_var <- enquo(group_var)
  
  df %>%
    filter(vs == 0) %>%
    group_by(!!group_var) %>%
    summarise(hp = mean(hp))  %>%
    kable()
  
}

summariser(mtcars, cyl)
```

## Bigger Example

We can also use quosures to assign an expression directly to an argument

```{r}
summariser <- function(df, filter_expression, group_var) {
  
  filter_expression <- enquo(filter_expression)
  group_var <- enquo(group_var)

  df %>%
    filter(!!filter_expression) %>%
    group_by(!!group_var) %>%
    summarise(hp = mean(hp)) %>%
    kable() 
  
}

summariser(mtcars, vs == 0, cyl)
```

## Bigger Example

```{r}
summariser <- function(df, filter_expression, group_var, summary_var) {
  
  filter_expression <- enquo(filter_expression)
  group_var <- enquo(group_var)
  summary_var <- enquo(summary_var)
  
  df %>%
    filter(!!filter_expression) %>%
    group_by(!!group_var) %>%
    summarise(x = mean(!!summary_var)) %>%
    kable() 
  
}

summariser(mtcars, vs == 0, cyl, hp)
```

## Bigger Example

```{r}
summariser <- function(df, filter_expression, group_var, summary_var) {
  
  filter_expression <- enquo(filter_expression)
  group_var <- enquo(group_var)
  summary_var <- enquo(summary_var)
  
  df %>%
    filter(!!filter_expression) %>%
    group_by(!!group_var) %>%
    summarise(!!summary_var = mean(!!summary_var)) %>%
    kable() 
  
}
```

`!!summary_var = mean(!!summary_var)` is not valid R code, the \``=`\` operator can only have object names on the LHS. We need to use \``:=`\` operator to unquote on both RHS and LHS.

## Definitions

\``:=`\`: bundles expressions on both the LHS and RHS. 

`quo_name()`: converts quoted symbol to string

## Bigger Example

```{r}
summariser <- function(df, filter_expression, group_var, summary_var) {
  
  filter_expression <- enquo(filter_expression)
  group_var <- enquo(group_var)
  summary_var <- enquo(summary_var)
  
    df %>%
      filter(!!filter_expression) %>%
      group_by(!!group_var) %>%
      summarise(!!summary_var := mean(!!summary_var)) %>%
      kable()
  
}

summariser(mtcars, vs == 0, cyl, hp)
```

## Bigger Example

```{r}
summariser <- function(df, filter_expression, group_var, summary_var) {
  
  filter_expression <- enquo(filter_expression)
  group_var <- enquo(group_var)
  summary_var <- enquo(summary_var)
  
  df %>%
    filter(!!filter_expression) %>%
    group_by(!!group_var) %>%
    summarise(!!quo_name(summary_var) := mean(!!summary_var)) %>%
    kable()
  
}

summariser(mtcars, vs == 0, cyl, hp)
```

## Definitions

`syms()`: takes a list of strings and converts to list of symbols

`quos()`: takes a list of expressions and returns list of quosures

`!!!`: unquotes each element of list, each component is embedded as its own argument in surrounding call

## Quos, syms, !!! example

```{r}

g <- c("gear", "cyl")

multiple_group <- function(df, group_vars, val_var) {
  
  group_vars <- syms(group_vars)
  val_var <- enquo(val_var)
  
  df %>%
    group_by(!!!group_vars) %>%
    summarise(mean(!!val_var)) %>%
    head(n=3) %>%
    kable()
  
}

```

## Quos, syms, !!! example

```{r}

multiple_group(mtcars, g, hp)
multiple_group(mtcars, "gear", hp)

```

## Quos, syms, !!! example

```{r}
multiple_group <- function(df, val_var, ...) {
  
  val_var <- enquo(val_var)
  groupings <- quos(...)
  
  df %>%
    group_by(!!!groupings) %>%
    summarise(mean(!!val_var)) %>%
    head(n=3) %>%
    kable()
  
}
```

## Quos, syms, !!! example

```{r}
multiple_group(mtcars, hp, gear)
multiple_group(mtcars, hp, gear, cyl)

```

## Quos example 2

```{r}
(example <- tibble(group=c(rep("A",6), rep("B",6)), val = c(1:5, NA, 7:11, 1000)))
```

## Quos example 2

```{r}
grouped_mean <- function(df, grouping_var, val_var, ...) {
  
  args <- quos(...)
  grouping_var <- enquo(grouping_var)
  val_var <- enquo(val_var)
  
  df %>%
    group_by(!!grouping_var) %>%
    summarise(value = mean(!!val_var, !!!args)) %>%
    kable()
  
}
```

## Quos example 2

```{r}
grouped_mean(example, group, val)
grouped_mean(example, group, val, na.rm = TRUE)
```

## Quos example 2

```{r}
grouped_mean(example, group, val, trim = .2)
grouped_mean(example, group, val, na.rm = TRUE, trim = .2)
```

## Allow either string or expression

```{r}
group_either <- function(var) {
  var <- as.character(substitute(var))
  var <- sym(var)
  
  mtcars %>%
    group_by(!!var) %>%
    summarise(mean(hp))
}
```

## Allow either string or expression

```{r}
group_either(cyl)
group_either("cyl")
```